{% extends "base.html" %}
{% block title %}Entries – Study Map{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Learning Entries</h1>
    <p>Browse and explore all your recorded study sessions.</p>
</div>

{% if entries|length == 0 %}
<div class="empty-state">
    <div class="empty-state-icon">&#128218;</div>
    <h3>No entries yet</h3>
    <p>Head to <a href="{{ url_for('log_entry') }}">Log Entry</a> to record your first session.</p>
</div>
{% else %}

<div class="stat-grid cols-3">
    <div class="stat-card"><div class="number">{{ stats.total }}</div><div class="label">Total Entries</div></div>
    <div class="stat-card"><div class="number">{{ stats.skills }}</div><div class="label">Unique Skills</div></div>
    <div class="stat-card"><div class="number">{{ stats.domains }}</div><div class="label">Domains</div></div>
</div>

<hr class="divider">

{% set colors = ['tag-purple', 'tag-coral', 'tag-teal', 'tag-blue', 'tag-amber'] %}

{% for e in entries %}
<div class="entry-card">
    <div class="entry-header">
        <div>
            <span class="entry-id">ENTRY #{{ e.id }}</span>
            {% if e.ai_classification and e.ai_classification.complexity %}
            <span class="tag tag-rose">{{ e.ai_classification.complexity|title }}</span>
            {% endif %}
            <div class="entry-title">{{ e.topic_title }}</div>
            {% if e.skills %}
            <div class="tags">
                {% for s in e.skills.split(', ') %}
                <span class="tag {{ colors[loop.index0 % colors|length] }}">{{ s }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div class="entry-date">{{ e.created_at[:10] if e.created_at else '' }}</div>
    </div>
    <div class="entry-summary">{{ e.summary[:250] }}{% if e.summary|length > 250 %}&hellip;{% endif %}</div>
</div>
{% endfor %}

<hr class="divider">

<h3>Entry Detail View</h3>
<div class="form-group">
    <label for="detailSelect">Select an entry</label>
    <select id="detailSelect" onchange="loadDetail(this.value)">
        {% for e in entries %}
        <option value="{{ e.id }}">#{{ e.id }} – {{ e.topic_title }}</option>
        {% endfor %}
    </select>
</div>

<div id="detailBox"></div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
var showingEnhanced = false;

function toggleSummary() {
    showingEnhanced = !showingEnhanced;
    document.getElementById('originalSummary').style.display = showingEnhanced ? 'none' : 'block';
    document.getElementById('enhancedSummary').style.display = showingEnhanced ? 'block' : 'none';
    document.getElementById('summaryToggle').textContent = showingEnhanced ? 'Show Original Notes' : 'Show Enhanced Notes';
}

function reEnhance(entryId) {
    var btn = document.getElementById('enhanceBtn');
    btn.textContent = 'Enhancing...';
    btn.disabled = true;
    fetch('/api/entry/' + entryId + '/enhance', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.enhanced_summary) {
                loadDetail(entryId);
            } else {
                btn.textContent = 'Enhancement failed';
            }
        })
        .catch(function() {
            btn.textContent = 'Enhancement failed';
            btn.disabled = false;
        });
}

function loadDetail(id) {
    showingEnhanced = false;
    fetch('/api/entry/' + id)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var html = '<div class="card" style="margin-top:12px;">';

            html += '<div class="card-label">Summary</div>';
            if (data.enhanced_summary) {
                html += '<div style="margin-bottom:10px;">';
                html += '<button class="btn btn-sm" onclick="toggleSummary()" id="summaryToggle">Show Enhanced Notes</button>';
                html += '</div>';
                html += '<div id="originalSummary" class="detail-summary">' + data.summary + '</div>';
                html += '<div id="enhancedSummary" class="detail-summary" style="display:none;">';
                html += '<span class="enhanced-badge">AI Enhanced</span>';
                html += '<div style="margin-top:8px;">' + data.enhanced_summary + '</div>';
                html += '</div>';
            } else {
                html += '<div class="detail-summary">' + data.summary + '</div>';
                html += '<div style="margin-top:10px;">';
                html += '<button class="btn btn-sm" onclick="reEnhance(' + data.id + ')" id="enhanceBtn">Enhance with AI</button>';
                html += '</div>';
            }

            if (data.ai_classification) {
                html += '<div class="card-label" style="margin-top:20px;">AI Classification</div>';
                html += '<pre class="json-block">' + JSON.stringify(data.ai_classification, null, 2) + '</pre>';
            }
            html += '</div>';
            document.getElementById('detailBox').innerHTML = html;
        });
}

document.addEventListener('DOMContentLoaded', function() {
    var sel = document.getElementById('detailSelect');
    if (sel && sel.value) loadDetail(sel.value);
});
</script>
{% endblock %}
